01. Install Docker :

https://github.com/mohimenulislam/cka-note/blob/4f6f2781eac352a7fa8a5e39c44671af16c0f72a/CKA/2.%20Docker%20Installation.md

3. Install kubeadm(master,worker), kubelet(master,worker), kubectl(Master)

 - add repo/source list
 - apt-get update
 - apt-get install kubeadm kubelet kubectl
   
5. Initialize the Cluster using Kubeadm init command. (Flanel)
6. export the kubeconfig
04. Verify the Cluster Status
05. Download and apply flannel network plugins
06. verify the status of Cluster
07. add worker nodes

### Installation 

| VMName | Name | IP | GW | DNS |
| --- | ---- | ---- | ---- | ---- | 
k8smaster1 | master1 | 192.168.10.100 | 192.168.10.1 | 8.8.8.8 |
k8sworker1 | worker1 | 192.168.10.101 | 192.168.10.1 | 8.8.8.8 |
k8sworker2 | worker2 | 192.168.10.102 | 192.168.10.1 | 8.8.8.8 |

### k8smaster1:
- hostname: master1
- Docker Engine
- kubeadm + kubectl + kubeadm
  
vi /etc/hosts
```bash
192.168.10.100  master1
192.168.10.101  worker1
192.168.10.102  worker2
```

### worker:
- Docker Engine
- kubeadm
  
vi /etc/hosts
```bash
192.168.10.100  master1
192.168.10.101  worker1
192.168.10.102  worker2
```


#### Swap off

```bash
free -m
swapoff -a

vi /etc/fstab
# make disable swap partition from fstab; use # before line
```

#### Add Repository and install kubeadm kubelet kubectl
```bash
dpkg -l | grep kube
```

```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```
Download Link: https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/


```bash
apt-get update
apt-get install kubeadm kubelet kubectl
dpkg -l | grep kube  # check
```

#### Load required modules

```bash
cd /etc/modules-load.d/

# Creat a file namecontainerd.conf

vi /etc/modules-load.d/namecontainerd.conf
  overlay
  br_netfilte

modprobe overlay
modprobe br_netfilter
```
Check
```bash
lsmod | grep overlay
lsmod | grep br_netfilter
```

#### IP forwarding enable

```bash
cd /etc/sysctl.d/
vi 10-k8s.conf

  net.bridge.bridge-nf-call-ip6tables = 1
  net.bridge.bridge-nf-call-iptables = 1
  net.ipv4.ip_forward = 1

sysctl --system
```

Check 
```bash
cat /proc/sys/net/ipv4/ip_forward
```

#### Check Cgroup driver
```bash
docker info | grep -i driver
  Storage Driver: overlay2
 Logging Driver: json-file
 Cgroup Driver: systemd

# if Cgroup Driver: systemd then its ok
```


```bash
cd /etc/default
vi kubelet

 KUBELET_EXTRA_ARGS="--cgroup-driver=cgroupfs"

systemctl daemon-reload
systemctl restart kubelet.service
```

#### Cluster Initialization

```bash
kubeadm init --pod-network-cidr=10.244.0.0/16
# If getting error

vi /etc/containerd/config.toml
# make disable using # before the line -- disabled_plugins = ["cri"]

systemctl restart containerd.service
```

```bash
kubeadm init --pod-network-cidr=10.244.0.0/16
```

Take this log
```bash
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 192.168.10.100:6443 --token ptn2y1.mpb4bgbd06ixqmg7 \
        --discovery-token-ca-cert-hash sha256:fc7b3c50c1ddfde25db31c6c27a6887a9340c41ababc72164b8e5983f4c3272e
```


```bash
kubectl get nodes
# We will get an error
```

```bash
export KUBECONFIG=/etc/kubernetes/admin.conf
```

```bash
kubectl get nodes
# no error
```

If I log out the again login we will get the same error. Thats why we entry below command

```bash
vi .bashrc
  export KUBECONFIG=/etc/kubernetes/admin.conf

source .bashrc
env | grep -i kube # check
```

#### kubectl bash completion

```bash
kubectl completion bash | sudo tee /etc/bash_completion.d/kubectl > /dev/null

logout # then login
```

```bash
kubectl get pods -A
```
#### Network plugins

Install flannel
```bash
wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

cat kube-flannel.yml | grep -i pod           # check
cat kube-flannel.yml | grep -i 10.244 -C 5   # check

kubectl apply -f kube-flannel.yml
```

We can see all pod are running
```bash
 kubectl get pods -A
```

Master node is ready
```bash
kubectl get nodes
```

#### Get Node details
```bash
kubectl get nodes -o wide
kubectl get nodes -o json
kubectl get nodes -o yaml
```

#### Default Namespace
```bash
kubectl get pods # getting error

kubectl get namespace
kubectl get pods -n kube-flannel   # -n: namespace
Kubectl get pods -n kube-system
```

 ### Add worker node

### Install Docker

https://github.com/mohimenulislam/cka-note/blob/4f6f2781eac352a7fa8a5e39c44671af16c0f72a/CKA/2.%20Docker%20Installation.md

 #### Add Repository to worker node
```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.34/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
```

```bash
apt-get update
```

#### Install kubeadm kubelet 
```bash
apt-get install kubeadm kubelet 
```

Check 
```bash
cat /proc/sys/net/ipv4/ip_forward
```

```bash
vi /etc/containerd/config.toml
# make disable using # before the line -- disabled_plugins = ["cri"]
systemctl restart docker.service

```

To join cluster check the file when we initialize the cluster or we can generate the tocken
```bash
kubeadm join 192.168.10.100:6443 --token ptn2y1.mpb4bgbd06ixqmg7 \
        --discovery-token-ca-cert-hash sha256:fc7b3c50c1ddfde25db31c6c27a6887a9340c41ababc72164b8e5983f4c3272e
```
#### Tocken Create
```bash
kubeadm token create
  rq002.lahp4g6nkf6rtpti

```

#### From master node

```bash
kubectl get nodes
kubectl get nodes -o wide
```



